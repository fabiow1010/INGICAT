{% extends 'base.html' %}
{% block content %}

<main class="container my-4">
  <h2 class="text-center mb-5">Dashboard de Predios</h2>

  <!-- Filtros -->
  <form method="GET" class="mb-4">
    <div class="row g-3">
      <div class="col-md-2">
        <label for="importancia" class="form-label">Importancia</label>
        <select name="importancia" class="form-select">
          <option value="">Todos</option>
          <option value="importante" {% if request.GET.importancia == 'importante' %}selected{% endif %}>Prioridad</option>
          <option value="normal" {% if request.GET.importancia == 'normal' %}selected{% endif %}>Normal</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="cod_sig" class="form-label">Código SIG</label>
        <input type="text" name="cod_sig" class="form-control" value="{{ request.GET.cod_sig }}">
      </div>
      <div class="col-md-2">
        <label for="fecha_inicio" class="form-label">Fecha Solicitud</label>
        <input type="date" name="fecha_inicio" class="form-control" value="{{ request.GET.fecha_inicio }}">
      </div>
      <div class="col-md-2">
        <label for="fecha_fin" class="form-label">Fecha Fin</label>
        <input type="date" name="fecha_fin" class="form-control" value="{{ request.GET.fecha_fin }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="{% url 'cliente_dashboard' %}" class="btn btn-secondary ms-2">Restablecer</a>
      </div>
    </div>
  </form>
  <!-- Tabla Responsiva -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover">
      <thead class="table-primary">
        <tr>
          <th>Id</th>
          <th>Proyecto</th>
          <th>Fecha Solicitud</th>
          <th>Gerencia</th>
          <th>Código SIG</th>
          <th>Entidad</th>
          <th>Prioridad</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for predio in ultimos_predios %}
        <tr {% if predio.es_importante %} class="table-danger" {% endif %}>
          <td><a href="{% url 'predio_detail' predio.id %}">{{ predio.id }}</a></td>
          <td>{{ predio.proyecto }}</td>
          <td>{{ predio.fecha_solicitud }}</td>
          <td>{{ predio.gerencia }}</td>
          <td>{{ predio.cod_sig }}</td>
          <td>{{ predio.entidad }}</td>
          <td>
            {% if predio.es_importante %}
              <span class="badge bg-danger">¡Prioridad!</span>
            {% else %}
              <span class="badge bg-success">Normal</span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'predio_detail' predio.id %}" class="btn btn-info btn-sm">Ver</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Gráficos -->
  <div class="row text-center mb-5">
    <div class="col-md-5 mb-5">
      <h5>Estado del Acciones</h5>
      <img src="data:image/png;base64,{{ graphic }}" class="img-fluid rounded shadow" alt="Gráfico de estados">
    </div>
    <div class="col-md-5 mb-5">
      <h5>Distribución Temporal de Solicitudes</h5>
      <img src="data:image/png;base64,{{ grafico_fechas }}" class="img-fluid rounded shadow" alt="Gráfico de fechas">
    </div>
  </div>


    <!-- Formulario de Lenguaje Natural -->
    <div class="card mb-5 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Consulta en Lenguaje Natural</h5>
        <form method="POST" class="row g-3">
          {% csrf_token %}
          <div class="col-12">
            {{ form_natural.consulta_natural }}
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-success">Ejecutar Consulta</button>
          </div>
        </form>
  
        {% if sql_generado %}
        <div class="mt-3 alert alert-info">
          <strong>Consulta Generada:</strong><br>
          <code>{{ sql_generado }}</code>
        </div>
        {% endif %}
  
        {% if error %}
        <div class="mt-3 alert alert-danger">
          {{ error }}
        </div>
        {% endif %}
  
        {% if resultados_nl %}
        <div class="mt-4">
          <h4>Resultados de la Consulta</h4>
          <div class="table-responsive">
            <table class="table table-striped table-bordered text-center">
              <thead class="table-dark">
                <tr>
                  {% for key in resultados_nl.0.keys %}
                    <th>{{ key }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for fila in resultados_nl %}
                  <tr>
                    {% for valor in fila.values %}
                      <td>{{ valor }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <a href="{% url 'exportar_consulta_excel' %}" class="btn btn-success mt-3">📥 Exportar a Excel</a>
        </div>
      {% endif %}
      </div>
    </div>
  
</main>

{% endblock %}
